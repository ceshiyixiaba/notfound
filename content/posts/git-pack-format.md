---
title: "Git Pack Format"
date: 2021-12-27T13:49:20+08:00
tags: [""]
categories: [""]
draft: true
---

## 头部 12-byte

- 4-byte 签名 `PACK`
- 4-byte 版本号，网络字节序，一般为 `2` 或者 `3`
- 4-byte 对象数量

```text
00000000  50 41 43 4b 00 00 00 02  00 00 00 03 9d 09 78 9c
          ----------- ============ ----------- == == -----
          P  A  C  K  版本 2       对象数量 3
```

## 对象条目

N 个对象条目，有两种类型 `undeltified` 和 `deltified`。

### undeltified

#### 类型和长度

- n-type 类型和长度(3-bit 类型, (n-1)*7+4-bit length)

类型包括:

- `OBJ_COMMIT` (1)
- `OBJ_TREE` (2)
- `OBJ_BLOB` (3)
- `OBJ_TAG` (4)
- `OBJ_OFS_DELTA` (6)
- `OBJ_REF_DELTA` (7)

```text
00000000  50 41 43 4b 00 00 00 02  00 00 00 03 9d 09 78 9c
          ----------- ============ ----------- ===== -----
          P  A  C  K  版本 2       对象数量 3 
```

`0x9d` = `0b1 001 1101` 
- `1` 表示需要继续读取下一个字节
- `001` 类型 commit
- `1101` 长度最低 4 位

`0x09` = `0b0 0001001`
- `0`，表示当前字节为最后一个字节
- `0001001` 长度高 7 位

所以数据长度为 `0b0001001 1101` = 0x9d = 157 字节

这里的数据长度是压缩前的大小，无法直接计算出下一个对象条目的位置。需要通过被压缩数据的计算下一个偏移。

#### 被压缩的数据

被压缩的数据，使用 zip 压缩算法

### deltified

- n-type 类型和长度(3-bit 类型, (n-1)*7+4-bit length)
- 两种类型，不同格式
  - OBJ_REF_DELTA 基础对象名称
  - OBJ_OFS_DELTA 非负的偏移量
- 被压缩的数据

## 校验和 20-byte

以上所有内容的 SHA1 值。

## 大小编码


## 仅包含 undeltified 示例

```text
# SHA-1 type size size-in-packfile offset-in-packfile

$ git verify-pack --verbose objects/pack/pack-2cfb729c72867b636434d061089d5cb1ca54080d.idx
d7587fecd33f43b9da698e3cac9e51fb777c3ea0 commit 157 122 12
21e80d51660eeebcdf01595ff4fff68914fea58f tree   38 48 134
670a245535fe6316eb2316c1103b1a88bb519334 blob   12 21 182
```

$ hexdump -C objects/pack/pack-2cfb729c72867b636434d061089d5cb1ca54080d.pack

```text
00000000  50 41 43 4b 00 00 00 02  00 00 00 03 9d 09 78 9c
          ----------- ============ ----------- == == ----- 16*0+2 = 2
          P  A  C  K  版本 2       对象数量 3  1001 1101
                                               ^--- ====
                                                  0000 1001
                                                  ^=== ====
                                              大小 000 1001 1101 = 0x9d = 157
                                          120 = 122(打包后大小) - 2(type + length)
00000010  8d cb 41 0a c2 30 10 46  e1 7d 4e 31 7b a1 4c 34
          ------------------------------------------------ 16*1+2 = 18
00000020  13 13 10 51 b0 4b 37 de  20 36 ff 68 a1 a1 52 46
          ------------------------------------------------ 16*2+2 = 34
00000030  e8 f1 ed 11 dc bc c5 07  cf 16 80 f6 1e 89 ab f8
          ------------------------------------------------ 16*3+2 = 50
00000040  18 19 c0 73 a8 ca 5e b2  a8 06 55 8d 29 fb a0 28
          ------------------------------------------------ 16*4+2 = 66
00000050  92 d4 95 af bd e7 85 5e  a3 d1 69 cb 05 6b 69 9f
          ------------------------------------------------ 16*5+2 = 82
00000060  09 dd 30 b7 33 f9 18 58  8e e1 90 33 ed 38 31 bb
          ------------------------------------------------ 16*6+2 = 98
00000070  4d db 68 86 bf 07 57 6a  a5 47 7f bd dd fb ce 56
          ------------------------------------------------ 16*7+2 = 114
00000080  73 3f d0 b8 2e c0 a6 02  78 9c 33 34 30 30 33 31
          ----------------- == ==  ----------------------- 16*0+8 = 8
                            1010 0110
                            ^--- ====
                               0000 0002
                               ^--- ====
                                000 0002 0110 = 0x26 = 38, 46 = 48 - 2
00000090  51 08 72 75 74 f1 75 d1  2b a9 28 61 48 e7 52 09
          ------------------------------------------------ 16*1+8 = 24
000000a0  35 fd 97 2c f6 5a 59 ec  a0 80 b5 54 c7 ee c0 c9
          ------------------------------------------------ 16*2+8 = 40
000000b0  26 00 ca 85 0b c6 3c 78  9c f3 48 cd c9 c9 d7 51
          ----------------- == --------------------------- 16*0+9
                            0011 1100
                            ^--- ====
                                 1100 = 0x0c = 12, 20 = 21 - 1
000000c0  70 cf 2c 51 e4 02 00 19  e2 03 90 2c fb 72 9c 72
          --------------------------------- ==============
                                            校验和 20 字节
000000d0  86 7b 63 64 34 d0 61 08  9d 5c b1 ca 54 08 0d
          =============================================
```

## 参考

- https://github.com/git/git/blob/v2.34.1/Documentation/technical/pack-format.txt
