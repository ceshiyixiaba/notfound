{"componentChunkName":"component---src-pages-posts-asciidoc-page-attributes-slug-tsx","path":"/posts/git-server-hooks/","result":{"data":{"asciidoc":{"id":"9a7a64a7-c424-50cf-8d91-07d3cc171f12","html":"<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>调用过程：</p>\n</div>\n<div class=\"olist arabic\">\n<ol class=\"arabic\">\n<li>\n<p><code>pre-receive</code> 可阻止所有 ref 更新</p>\n</li>\n<li>\n<p><code>update</code> 可阻止单个 ref 更新</p>\n</li>\n<li>\n<p><code>post-receive</code> 无法阻止 ref 更新</p>\n</li>\n</ol>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_pre_receive\"><a class=\"anchor\" href=\"#_pre_receive\"></a>pre-receive</h2>\n<div class=\"sectionbody\">\n<div class=\"sect2\">\n<h3 id=\"_特点\"><a class=\"anchor\" href=\"#_特点\"></a>特点</h3>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>无参数调用</p>\n</li>\n<li>\n<p>标准输入传递引用信息</p>\n</li>\n<li>\n<p>以非零值退出，所有的推送内容都不会被接受</p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_用途\"><a class=\"anchor\" href=\"#_用途\"></a>用途</h3>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>钩子阻止对引用进行非快进（non-fast-forward）的更新</p>\n</li>\n<li>\n<p>对该推送所修改的所有引用和文件进行访问控制</p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_示例\"><a class=\"anchor\" href=\"#_示例\"></a>示例</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\">#!/usr/bin/env ruby\n\nLINE = '-' * 80\n\nputs LINE\nENV.each do |k, v|\n  puts \"#{k}=#{v}\" if k.start_with?('GIT')\nend\n\nputs LINE\n# sha1-old SP sha1-new SP refname LF\nwhile line = STDIN.gets\n  puts line\nend\n\nputs LINE\nexit(1)</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>推送两个分支</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">git push origin master:master master:dev\n枚举对象: 3, 完成.\n对象计数中: 100% (3/3), 完成.\n使用 4 个线程进行压缩\n压缩对象中: 100% (2/2), 完成.\n写入对象中: 100% (2/2), 218 字节 | 218.00 KiB/s, 完成.\n总共 2（差异 0），复用 0（差异 0），包复用 0\nremote: --------------------------------------------------------------------------------\nremote: GIT_ALTERNATE_OBJECT_DIRECTORIES=/tmp/git/example.git/./objects\nremote: GIT_DIR=.\nremote: GIT_EXEC_PATH=/usr/lib/git-core\nremote: GIT_OBJECT_DIRECTORY=/tmp/git/example.git/./objects/incoming-UqdPAn\nremote: GIT_PUSH_OPTION_COUNT=0\nremote: GIT_QUARANTINE_PATH=/tmp/git/example.git/./objects/incoming-UqdPAn\nremote: --------------------------------------------------------------------------------\nremote: 2f2cccd39a3f1dab015f19497da59656d268c2dd 2c4c31b2be6a45b3664a7aebc384748ecf835056 refs/heads/dev\nremote: 2f2cccd39a3f1dab015f19497da59656d268c2dd 2c4c31b2be6a45b3664a7aebc384748ecf835056 refs/heads/master\nremote: --------------------------------------------------------------------------------\nTo /tmp/git/example.git\n ! [remote rejected] master -&gt; dev (pre-receive hook declined)\n ! [remote rejected] master -&gt; master (pre-receive hook declined)\nerror: 推送一些引用到 '/tmp/git/example.git' 失败</code></pre>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_update\"><a class=\"anchor\" href=\"#_update\"></a>update</h2>\n<div class=\"sectionbody\">\n<div class=\"sect2\">\n<h3 id=\"_特点_2\"><a class=\"anchor\" href=\"#_特点_2\"></a>特点</h3>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>受三个参数：引用的名字（分支），推送前的引用指向的内容的 SHA-1 值，以及用户准备推送的内容的 SHA-1 值</p>\n</li>\n<li>\n<p>会为每一个准备更新的分支各运行一次</p>\n</li>\n<li>\n<p>如果 update 脚本以非零值退出，只有相应的那一个引用会被拒绝；其余的依然会被更新</p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_用途_2\"><a class=\"anchor\" href=\"#_用途_2\"></a>用途</h3>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>钩子阻止对引用进行非快进（non-fast-forward）的更新</p>\n</li>\n<li>\n<p>对该推送所修改的所有引用和文件进行访问控制</p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_示例_2\"><a class=\"anchor\" href=\"#_示例_2\"></a>示例</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\">#!/usr/bin/env ruby\n\nLINE = '-' * 80\n\nputs LINE\nputs ARGV\nputs LINE\n\nexit(1)</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>推送两个分支：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">git push origin master:master master:dev\n枚举对象: 3, 完成.\n对象计数中: 100% (3/3), 完成.\n使用 4 个线程进行压缩\n压缩对象中: 100% (2/2), 完成.\n写入对象中: 100% (2/2), 218 字节 | 218.00 KiB/s, 完成.\n总共 2（差异 0），复用 0（差异 0），包复用 0\nremote: --------------------------------------------------------------------------------\nremote: refs/heads/dev\nremote: 2f2cccd39a3f1dab015f19497da59656d268c2dd\nremote: 2c4c31b2be6a45b3664a7aebc384748ecf835056\nremote: --------------------------------------------------------------------------------\nremote: error: hook declined to update refs/heads/dev\nremote: --------------------------------------------------------------------------------\nremote: refs/heads/master\nremote: 2f2cccd39a3f1dab015f19497da59656d268c2dd\nremote: 2c4c31b2be6a45b3664a7aebc384748ecf835056\nremote: --------------------------------------------------------------------------------\nremote: error: hook declined to update refs/heads/master\nTo /tmp/git/example.git\n ! [remote rejected] master -&gt; dev (hook declined)\n ! [remote rejected] master -&gt; master (hook declined)\nerror: 推送一些引用到 '/tmp/git/example.git' 失败</code></pre>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_post_receive\"><a class=\"anchor\" href=\"#_post_receive\"></a>post-receive</h2>\n<div class=\"sectionbody\">\n<div class=\"sect2\">\n<h3 id=\"_特点_3\"><a class=\"anchor\" href=\"#_特点_3\"></a>特点</h3>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>无参数调用</p>\n</li>\n<li>\n<p>标准输入传递引用信息</p>\n</li>\n<li>\n<p>在整个过程完结以后运行</p>\n</li>\n<li>\n<p>无法终止推送进程</p>\n</li>\n<li>\n<p>客户端在它结束运行之前将保持连接状态</p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_用途_3\"><a class=\"anchor\" href=\"#_用途_3\"></a>用途</h3>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>更新其他系统服务或者通知用户</p>\n</li>\n</ul>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_示例_3\"><a class=\"anchor\" href=\"#_示例_3\"></a>示例</h3>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-ruby\" data-lang=\"ruby\">#!/usr/bin/env ruby\n\nLINE = '-' * 80\n\nputs LINE\nENV.each do |k, v|\n  puts \"#{k}=#{v}\" if k.start_with?('GIT')\nend\n\nputs LINE\n# sha1-old SP sha1-new SP refname LF\nwhile line = STDIN.gets\n  puts line\nend\n\nputs LINE\nexit(1)</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>推送两个分支：</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-text\" data-lang=\"text\">git push origin master:master master:dev\n枚举对象: 3, 完成.\n对象计数中: 100% (3/3), 完成.\n使用 4 个线程进行压缩\n压缩对象中: 100% (2/2), 完成.\n写入对象中: 100% (2/2), 214 字节 | 214.00 KiB/s, 完成.\n总共 2（差异 1），复用 0（差异 0），包复用 0\nremote: --------------------------------------------------------------------------------\nremote: GIT_DIR=.\nremote: GIT_EXEC_PATH=/usr/lib/git-core\nremote: GIT_PUSH_OPTION_COUNT=0\nremote: --------------------------------------------------------------------------------\nremote: 07e90506b50083173ff08015f115403c466dfcf5 17f4a373571ac61e82a591dc51b353c6fa02af90 refs/heads/dev\nremote: 07e90506b50083173ff08015f115403c466dfcf5 17f4a373571ac61e82a591dc51b353c6fa02af90 refs/heads/master\nremote: --------------------------------------------------------------------------------\nTo /tmp/git/example.git\n   07e9050..17f4a37  master -&gt; dev\n   07e9050..17f4a37  master -&gt; maste</code></pre>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_参考\"><a class=\"anchor\" href=\"#_参考\"></a>参考</h2>\n<div class=\"sectionbody\">\n<div class=\"ulist\">\n<ul>\n<li>\n<p><a href=\"https://git-scm.com/book/zh/v2/%E8%87%AA%E5%AE%9A%E4%B9%89-Git-Git-%E9%92%A9%E5%AD%90\">自定义 Git - Git 钩子</a></p>\n</li>\n</ul>\n</div>\n</div>\n</div>","document":{"title":"Git 服务端 Hooks"},"pageAttributes":{"slug":"git-server-hooks","category":"git"},"revision":{"date":"2020-06-20","number":"1.0"}}},"pageContext":{"id":"9a7a64a7-c424-50cf-8d91-07d3cc171f12","pageAttributes__slug":"git-server-hooks","__params":{"pageAttributes__slug":"git-server-hooks"}}},"staticQueryHashes":["3143286284"]}